# ğŸ“˜ quant-stock-list æ¨¡å—è½åœ°ä¸é¢è¯•è®²è§£æ‰‹å†Œ

> ä½œè€…ï¼šææ˜Š  
> æ¨¡å—å®šä½ï¼šåˆ†å¸ƒå¼é‡åŒ–é€‰è‚¡ç³»ç»Ÿä¸­çš„ **é«˜å¹¶å‘æŸ¥è¯¢æœåŠ¡**  
> æŠ€æœ¯æ ˆï¼šSpring Boot 3.5ã€MyBatisã€Redisã€Caffeineã€Kafkaã€Prometheus  
> ç›®æ ‡ï¼šæ”¯æ’‘æ¯æ—¥ç­–ç•¥ç»“æœçš„é«˜å¹¶å‘ã€ä½å»¶è¿Ÿè®¿é—®åœºæ™¯

---

## ğŸ¯ 1. æ¨¡å—å®šä½ä¸èŒè´£

| é¡¹ç›®è¦ç´  | è¯´æ˜ |
|-----------|------|
| **æ¨¡å—å** | `quant-stock-list` |
| **åŠŸèƒ½å®šä½** | æä¾›æ¯æ—¥ç¨³å®šè‚¡ç¥¨åˆ—è¡¨çš„é«˜æ€§èƒ½æŸ¥è¯¢æœåŠ¡ |
| **è¾“å…¥æ¥æº** | `strategy_daily_picks`ï¼ˆç­–ç•¥äº§å‡ºè¡¨ï¼‰ |
| **æ›´æ–°é¢‘ç‡** | æ¯æ—¥å‡Œæ™¨æ‰¹é‡æ›´æ–°ï¼ˆä½å†™é¢‘ï¼‰ |
| **æ ¸å¿ƒç‰¹å¾** | è¯»å¤šå†™å°‘ã€ç¼“å­˜ä¸ºä¸»ã€å¼‚æ­¥åˆ·æ–°ã€é«˜å¹¶å‘å®‰å…¨ |
| **æ¶æ„æ¨¡å¼** | CQRSï¼ˆå†™ï¼šç­–ç•¥è®¡ç®—æœåŠ¡ï¼Œè¯»ï¼šstock-listæœåŠ¡ï¼‰ |

---

## ğŸ§± 2. æ¨¡å—æ¶æ„æ¦‚è§ˆ

```mermaid
graph TD
    Client --> StablePicksController[Controller: å‚æ•°æ ¡éªŒ + é™æµ]
    StablePicksController --> StablePicksService[Service: æ ¸å¿ƒä¸šåŠ¡]
    
    subgraph StablePicksService
        direction LR
        BloomFilter[å¸ƒéš†è¿‡æ»¤å™¨<br/>(é˜²ç©¿é€)]
        Caffeine[Caffeine<br/>(L1 ç¼“å­˜)]
        Redis[Redis<br/>(L2 ç¼“å­˜)]
        DB[DBå›æº<br/>(åˆ†å¸ƒå¼é”é˜²å‡»ç©¿)]
    end

    StablePicksService --> BloomFilter
    StablePicksService --> Caffeine
    StablePicksService --> Redis
    StablePicksService --> DB
    
    DB --> MySQL[(MySQL<br/>æŒ‰æœˆåˆ†åŒºè¡¨)]
    MySQL --> Kafka[Kafka: strategy.result.completed<br/>(å¼‚æ­¥ç¼“å­˜åˆ·æ–°)]
    Kafka --> StablePicksService
```

---

## ğŸ§© 3. æ ¸å¿ƒæŠ€æœ¯ç‚¹æ€»è§ˆ

| ç±»åˆ« | å®ç°è¦ç‚¹ | è¯´æ˜ |
|------|-----------|------|
| **å¤šçº§ç¼“å­˜** | Caffeineï¼ˆL1ï¼‰+ Redisï¼ˆL2ï¼‰ | æœ¬åœ°å¿«é€Ÿ + åˆ†å¸ƒå¼å…±äº« |
| **å¸ƒéš†è¿‡æ»¤å™¨** | Redis Bitmap | æ‹¦æˆªéäº¤æ˜“æ—¥æŸ¥è¯¢è¯·æ±‚ |
| **ç¼“å­˜å‡»ç©¿é˜²æŠ¤** | Redisson åˆ†å¸ƒå¼é” + Double Check | æ§åˆ¶å›æºæµé‡ |
| **é€»è¾‘è¿‡æœŸæœºåˆ¶** | CacheWrapper + å¼‚æ­¥åˆ·æ–° | è¿”å›æ—§æ•°æ®é¿å…é˜»å¡ |
| **ç¼“å­˜é›ªå´©é˜²æŠ¤** | éšæœºTTL + é”™å³°é¢„çƒ­ | é¿å…åŒä¸€æ—¶é—´ç¼“å­˜å…¨å¤±æ•ˆ |
| **æ•°æ®ä¸€è‡´æ€§** | Kafka äº‹ä»¶é©±åŠ¨åˆ·æ–° + ç‰ˆæœ¬å·æ ¡éªŒ | å®ç°æœ€ç»ˆä¸€è‡´æ€§ |
| **ç›‘æ§æŒ‡æ ‡** | Micrometer â†’ Prometheus â†’ Grafana | L1/L2å‘½ä¸­ç‡ã€å›æºæ¬¡æ•°ã€å»¶è¿Ÿ |
| **å‹æµ‹éªŒè¯** | Gatling è„šæœ¬ | éªŒè¯é«˜å¹¶å‘åœºæ™¯æ€§èƒ½è¡¨ç° |

---

## âš™ï¸ 4. ç³»ç»Ÿåˆ†å±‚ç»“æ„

```
com.hao.strategyengine.module.stablepicks
â”œâ”€â”€ application
â”‚   â””â”€â”€ StablePicksController.java     # REST API å±‚
â”œâ”€â”€ domain
â”‚   â”œâ”€â”€ StablePicksService.java        # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ StrategyResultWriter.java      # å†™ç«¯é€»è¾‘ + Kafkaäº‹ä»¶å‘å¸ƒ
â”œâ”€â”€ infrastructure
â”‚   â”œâ”€â”€ StablePicksMapper.java         # MyBatis æ˜ å°„
â”‚   â”œâ”€â”€ CacheWrapper.java              # ç¼“å­˜åŒ…è£…ç±»(é€»è¾‘è¿‡æœŸ)
â”‚   â”œâ”€â”€ redisã€lockã€bloomç›¸å…³å°è£…ç±»
â”œâ”€â”€ config
â”‚   â””â”€â”€ StablePicksCacheConfiguration.java  # ç¼“å­˜ä¸äº‹åŠ¡é…ç½®
â”œâ”€â”€ metrics
â”‚   â””â”€â”€ StablePicksMetrics.java        # Prometheus ç›‘æ§æŒ‡æ ‡
â””â”€â”€ resources
â”œâ”€â”€ mapper/StablePicksMapper.xml
â””â”€â”€ db/schema.sql
```

---

## ğŸ§  5. æŠ€æœ¯äº®ç‚¹è¯¦è§£

### (1) å¤šçº§ç¼“å­˜æŸ¥è¯¢æµç¨‹

```
è¯·æ±‚è¿›å…¥ â†’ BloomFilterè¿‡æ»¤ â†’ æŸ¥Caffeine â†’ æŸ¥Redis â†’ æ‹¿é”é˜²å‡»ç©¿ â†’ å›æºDB â†’ å¼‚æ­¥åˆ·æ–°
```

| å±‚çº§ | æŠ€æœ¯ | ç¼“å­˜æ—¶é—´ | ç‰¹ç‚¹ |
|------|------|-----------|------|
| L1 | Caffeine | 5åˆ†é’Ÿ | æœ¬åœ°ç¼“å­˜ï¼Œæä½å»¶è¿Ÿ |
| L2 | Redis | 10åˆ†é’Ÿ | åˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼Œé€»è¾‘è¿‡æœŸ |
| L3 | MySQL | æŒ‰æ—¥åˆ†åŒº | DBå›æº + å¼‚æ­¥å†™å› |

---

### (2) åˆ†å¸ƒå¼é”é˜²å‡»ç©¿
- ä½¿ç”¨ **Redisson** å®ç°å¯é‡å…¥é”ï¼›
- ä»…ä¸€ä¸ªçº¿ç¨‹èƒ½å›æºDBï¼›
- å…¶ä»–çº¿ç¨‹è¿”å›æ—§ç¼“å­˜æˆ–ç­‰å¾…åˆ·æ–°ã€‚

### (3) é€»è¾‘è¿‡æœŸ + å¼‚æ­¥åˆ·æ–°
- ç¼“å­˜åŒ…è£…å™¨ `CacheWrapper<T>` å®šä¹‰ `expireTime` ä¸ `softExpireTime`ï¼›
- è‹¥å¤„äºè½¯TTLï¼Œå…è®¸è¿”å›æ—§å€¼ï¼ŒåŒæ—¶è§¦å‘åå°å¼‚æ­¥åˆ·æ–°ã€‚

### (4) Kafkaäº‹ä»¶é©±åŠ¨åˆ·æ–°
- ç­–ç•¥å†™å…¥æœåŠ¡ï¼ˆ`StrategyResultWriter`ï¼‰åœ¨äº‹åŠ¡æäº¤åå‘é€äº‹ä»¶ï¼›
- æ¶ˆè´¹ç«¯ï¼ˆ`CacheRefresher`ï¼‰æ”¶åˆ°ååˆ·æ–°å¯¹åº”ç¼“å­˜ï¼›
- ä½¿ç”¨ `version` å­—æ®µé˜²æ­¢æ—§æ•°æ®è¦†ç›–æ–°æ•°æ®ã€‚

### (5) ç›‘æ§ä¸å‘Šè­¦
- Micrometer æš´éœ²æŒ‡æ ‡è‡³ Prometheusï¼›
- Grafana å±•ç¤ºï¼š
  - ç¼“å­˜å‘½ä¸­ç‡è¶‹åŠ¿ï¼›
  - DBå›æºæ¬¡æ•°ï¼›
  - P99å»¶è¿Ÿï¼›
  - å¸ƒéš†è¿‡æ»¤å™¨æ‹¦æˆªç‡ï¼›
- å‘Šè­¦è§„åˆ™ï¼š
  - L1å‘½ä¸­ç‡ < 70%ï¼›
  - å›æºæ¬¡æ•° > 100/minï¼›
  - P99å»¶è¿Ÿ > 100msã€‚

---

## ğŸ“Š 6. æ€§èƒ½å‹æµ‹ç»“æœï¼ˆç¤ºä¾‹ï¼‰

| åœºæ™¯ | QPS | P99å»¶è¿Ÿ | å‘½ä¸­ç‡ | å¤‡æ³¨ |
|------|-----|----------|--------|------|
| æ­£å¸¸æŸ¥è¯¢ | 1000 | 80ms | 95% | ç¨³å®š |
| çƒ­ç‚¹Key | 5000 | 90ms | 99% | åˆ†å¸ƒå¼é”é˜²å‡»ç©¿æˆåŠŸ |
| éäº¤æ˜“æ—¥æŸ¥è¯¢ | 1000 | 30ms | - | å¸ƒéš†è¿‡æ»¤å™¨æ‹¦æˆªç‡99.7% |
| é›ªå´©æ¨¡æ‹Ÿ | 3000 | <120ms | 93% | éšæœºTTLç”Ÿæ•ˆ |

---

## ğŸ§© 7. é¢è¯•é—®ç­”é€Ÿè®°

| é¢è¯•å®˜é—®é¢˜ | å›ç­”äº®ç‚¹ |
|-------------|-----------|
| **ä¸ºä»€ä¹ˆé‡‡ç”¨å¤šçº§ç¼“å­˜ï¼Ÿ** | Caffeineå¤„ç†çƒ­ç‚¹ã€Rediså…±äº«è·¨å®ä¾‹ï¼Œæå‡å‘½ä¸­ç‡ä¸ä½å»¶è¿Ÿã€‚ |
| **ç¼“å­˜ä¸€è‡´æ€§æ€ä¹ˆä¿è¯ï¼Ÿ** | Kafkaäº‹ä»¶ + ç‰ˆæœ¬å·æ§åˆ¶ + å¹‚ç­‰æœºåˆ¶ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚ |
| **ç¼“å­˜é›ªå´©/å‡»ç©¿/ç©¿é€å¦‚ä½•é˜²ï¼Ÿ** | TTLéšæœºåŒ– + Redissoné” + BloomFilterã€‚ |
| **Rediså®•æœºäº†æ€ä¹ˆåŠï¼Ÿ** | é™çº§ï¼šæŸ¥DBè¿”å›å¹¶è®°å½•fallbackæŒ‡æ ‡ã€‚ |
| **ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨Guavaï¼Ÿ** | Caffeineæ”¯æŒæ›´é«˜QPSã€ç»Ÿè®¡å‘½ä¸­ç‡ï¼Œä¸”çº¿ç¨‹å®‰å…¨ä¼˜åŒ–æ›´å¥½ã€‚ |
| **æ€ä¹ˆç›‘æ§å‘½ä¸­ç‡å’Œå»¶è¿Ÿï¼Ÿ** | MicrometeræŒ‡æ ‡ â†’ Prometheus â†’ Grafanaã€‚ |
| **å‹æµ‹ç»“æœå¦‚ä½•ï¼Ÿ** | 1000 QPSä¸‹ P99 < 100msï¼Œå‘½ä¸­ç‡95%ä»¥ä¸Šã€‚ |

---

## ğŸ’¬ 8. é¢è¯•è®²è§£æ¨¡æ¿ï¼ˆæ¨èå£å¾„ï¼‰

> â€œè¿™ä¸ªæ¨¡å—æ˜¯æˆ‘ä¸ºåˆ†å¸ƒå¼é‡åŒ–ç³»ç»Ÿè®¾è®¡çš„ **æ¯æ—¥ç²¾é€‰è‚¡ç¥¨æŸ¥è¯¢æœåŠ¡**ï¼Œ  
> æ ¸å¿ƒç›®æ ‡æ˜¯è§£å†³é«˜å¹¶å‘æŸ¥è¯¢ä¸‹çš„ç¼“å­˜å‡»ç©¿ã€é›ªå´©ã€ç©¿é€é—®é¢˜ã€‚  
> æˆ‘é‡‡ç”¨äº† **Caffeine + Redis äºŒçº§ç¼“å­˜** çš„åˆ†å±‚ç­–ç•¥ï¼Œå¹¶é€šè¿‡  
> **å¸ƒéš†è¿‡æ»¤å™¨ + åˆ†å¸ƒå¼é” + é€»è¾‘è¿‡æœŸ + Kafka å¼‚æ­¥åˆ·æ–°** æ¥ä¿è¯ç³»ç»Ÿåœ¨  
> é«˜QPSåœºæ™¯ä¸‹ä¾æ—§ç¨³å®šã€‚  
>  
> æ­¤å¤–ï¼Œæˆ‘è¿˜è®¾è®¡äº† **Prometheus ç›‘æ§æŒ‡æ ‡ + Grafana å‘Šè­¦**ï¼Œ  
> å¹¶é€šè¿‡ Gatling å‹æµ‹éªŒè¯åœ¨ 1000 QPS ä¸‹çš„ç¨³å®šæ€§ã€‚  
>  
> è¿™ä¸ªæ¨¡å—ä½“ç°äº†æˆ‘å¯¹åˆ†å¸ƒå¼ç¼“å­˜æ²»ç†ã€æ•°æ®ä¸€è‡´æ€§ã€å¯è§‚æµ‹æ€§  
> çš„å…¨æ ˆå·¥ç¨‹æ€ç»´ã€‚â€

---

## ğŸ“ˆ 9. æ¶æ„æ€»è§ˆå›¾

```mermaid
flowchart TD
    A[Client / API Gateway] --> B[StablePicksController]
    B --> C[StablePicksService]
    C --> D1[BloomFilter]
    C --> D2[Caffeine (L1 Cache)]
    C --> D3[Redis (L2 Cache)]
    C --> D4[MySQL Partition Table]
    D4 --> E[Kafka: strategy.result.completed]
    E --> F[CacheRefresher -> Redis + Caffeine]
    C --> G[Prometheus Metrics Exporter]
    G --> H[Grafana Dashboard]
```

---

## ğŸ§¾ 10. å¯æ‰©å±•æ–¹å‘

* å¢åŠ  **çƒ­ç‚¹KeyåŠ¨æ€è¯†åˆ«ä¸é¢„çƒ­**ï¼›
* å¼•å…¥ **Spring Cloud Stream** ä¼˜åŒ– Kafka æ¶ˆæ¯æ¶ˆè´¹ï¼›
* ä½¿ç”¨ **Redis Bloom Module** è¿›ä¸€æ­¥é™ä½è¯¯åˆ¤ï¼›
* ç»“åˆ **Resilience4j** å¢åŠ ç†”æ–­ä¸é‡è¯•æœºåˆ¶ï¼›
* å¢åŠ  **æŸ¥è¯¢ç»´åº¦ç¼“å­˜åˆ†ç»„**ï¼ˆæŒ‰ç­–ç•¥IDåˆ†å±‚ï¼‰ã€‚

---

## âœ… æ€»ç»“

> `quant-stock-list` æ¨¡å—ä¸ä»…æ˜¯ä¸€ä¸ªâ€œæŸ¥è¯¢æœåŠ¡â€ï¼Œ
> æ›´æ˜¯ä¸€ä¸ªä½“ç° **ç¼“å­˜æ¶æ„èƒ½åŠ›ã€åˆ†å¸ƒå¼è®¾è®¡æ€ç»´ã€å·¥ç¨‹å¯è§‚æµ‹æ€§** çš„ç»¼åˆæ¡ˆä¾‹ã€‚
>
> å®ƒèƒ½åœ¨å¤§å‚é¢è¯•ä¸­æˆä¸ºâ€œ**ä½ èƒ½è®²é€çš„ç³»ç»Ÿè®¾è®¡é¢˜**â€ï¼Œ
> å¹¶é€šè¿‡çœŸå®ä»£ç ã€æ¶æ„å›¾ä¸æ€§èƒ½éªŒè¯æ”¯æ’‘ä½ çš„æ€è·¯ã€‚
