<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hao.datacollector.dal.dao.QuotationMapper">
    <resultMap id="HistoryTrendDataMap" type="com.hao.datacollector.dto.quotation.HistoryTrendDTO">
        <result property="windCode" column="wind_code"/>
        <result property="tradeDate" column="trade_date"/>
        <result property="latestPrice" column="latest_price"/>
        <result property="totalVolume" column="total_volume"/>
        <result property="averagePrice" column="average_price"/>
    </resultMap>

    <insert id="insertQuotationStockBaseList" parameterType="java.util.List">
        INSERT IGNORE INTO tb_quotation_stock_base (
        wind_code,
        trade_date,
        open_price,
        high_price,
        low_price,
        volume,
        amount,
        close_price,
        turnover_rate
        )
        VALUES
        <foreach collection="baseQuotationList" item="item" separator=",">
            (
            #{item.windCode},
            #{item.tradeDate},
            #{item.openPrice},
            #{item.highPrice},
            #{item.lowPrice},
            #{item.volume},
            #{item.amount},
            #{item.closePrice},
            #{item.turnoverRate}
            )
        </foreach>
    </insert>

    <select id="getJobQuotationBaseEndWindCodeList">
        SELECT DISTINCT wind_code
        FROM tb_quotation_stock_base
        WHERE 1 = 1
        <if test="startDate != null and startDate != ''">
            AND `trade_date` <![CDATA[>=]]>  #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND `trade_date` <![CDATA[<]]>  #{endDate}
        </if>
    </select>


    <insert id="insertQuotationHistoryTrendList" parameterType="java.util.List">
        INSERT IGNORE INTO tb_quotation_history_hot (
        wind_code,
        trade_date,
        latest_price,
        total_volume,
        average_price
        )
        VALUES
        <foreach collection="historyTrendQuotationList" item="item" separator=",">
            (
            #{item.windCode},
            #{item.tradeDate},
            #{item.latestPrice},
            #{item.totalVolume},
            #{item.averagePrice}
            )
        </foreach>
    </insert>

    <select id="getMaxHistoryTrendEndDate" resultType="string">
        SELECT DATE_FORMAT(MAX(trade_date), '%Y%m%d')
        FROM tb_quotation_history_hot
        WHERE trade_date >= '2025-11-01'; -- 给定一个近期的时间下限
    </select>

    <select id="getCompletedWindCodes" resultType="string">
        SELECT DISTINCT wind_code
        FROM tb_quotation_history_hot
        WHERE trade_date >= STR_TO_DATE(#{maxEndDate}, '%Y%m%d')
          AND trade_date <![CDATA[<]]> DATE_ADD(STR_TO_DATE(#{maxEndDate}, '%Y%m%d'), INTERVAL 1 DAY)
    </select>

    <select id="getMaxHistoryIndexTrendEndDate" resultType="string">
        SELECT DATE_FORMAT(MAX(trade_date), '%Y%m%d')
        FROM tb_quotation_index_history_trend
        WHERE trade_date >= STR_TO_DATE(CONCAT(#{year}, '0101'), '%Y%m%d')
          AND trade_date <![CDATA[<]]> STR_TO_DATE(CONCAT(#{year} + 1, '0101'), '%Y%m%d');
    </select>

    <select id="getCompletedIndexCodes" resultType="string">
        SELECT DISTINCT wind_code
        FROM tb_quotation_index_history_trend
        WHERE trade_date >= STR_TO_DATE(#{maxEndDate}, '%Y%m%d')
          AND trade_date <![CDATA[<]]> DATE_ADD(STR_TO_DATE(#{maxEndDate}, '%Y%m%d'), INTERVAL 1 DAY)
    </select>

    <insert id="insertQuotationIndexHistoryTrendList" parameterType="java.util.List">
        INSERT IGNORE INTO tb_quotation_index_history_trend (
        wind_code,
        trade_date,
        latest_price,
        total_volume,
        total_amount
        )
        VALUES
        <foreach collection="historyTrendQuotationList" item="item" separator=",">
            (
            #{item.windCode},
            #{item.tradeDate},
            #{item.latestPrice},
            #{item.totalVolume},
            #{item.totalAmount}
            )
        </foreach>
    </insert>

    <select id="selectByWindCodeListAndDate" resultMap="HistoryTrendDataMap">
        SELECT
        wind_code,
        trade_date,
        latest_price,
        total_volume,
        average_price
        FROM ${tableName}
        WHERE trade_date <![CDATA[>=]]> #{startDate}
        AND trade_date <![CDATA[<=]]> #{endDate}
        <if test="windCodeList != null and windCodeList.size() > 0">
            AND wind_code IN
            <foreach collection="windCodeList" item="code" open="(" separator="," close=")">
                #{code}
            </foreach>
        </if>
        ORDER BY trade_date ASC
    </select>

    <!-- 优化查询：仅获取每日收盘价（最后一条分时数据） -->
    <!-- 方案一：业务逻辑剪枝优化 -->
    <!-- 通过增加 TIME(trade_date) >= '14:50:00' 过滤条件，大幅减少参与窗口函数计算和排序的数据量 -->
    <!-- 适用于 A 股市场，收盘价通常产生在 14:50 之后 -->
    <select id="selectDailyClosePriceByWindCodeListAndDate" resultMap="HistoryTrendDataMap">
        WITH RankedData AS (
            SELECT
                wind_code,
                trade_date,
                latest_price,
                ROW_NUMBER() OVER (PARTITION BY wind_code, DATE(trade_date) ORDER BY trade_date DESC) as rn
            FROM ${tableName}
            WHERE trade_date <![CDATA[>=]]> #{startDate}
              AND trade_date <![CDATA[<=]]> #{endDate}

              <!-- 核心优化：只处理 14:50 之后的数据，过滤掉 95% 的无效数据 -->
              AND TIME(trade_date) >= '14:50:00'

            <if test="windCodeList != null and windCodeList.size() > 0">
                AND wind_code IN
                <foreach collection="windCodeList" item="code" open="(" separator="," close=")">
                    #{code}
                </foreach>
            </if>
        )
        SELECT
            wind_code,
            trade_date,
            latest_price
        FROM RankedData
        WHERE rn = 1
        ORDER BY trade_date ASC
    </select>

    <!-- 指标历史分时数据查询 ResultMap -->
    <resultMap id="HistoryTrendIndexDataMap" type="com.hao.datacollector.dto.quotation.HistoryTrendIndexDTO">
        <result property="windCode" column="wind_code"/>
        <result property="tradeDate" column="trade_date"/>
        <result property="latestPrice" column="latest_price"/>
        <result property="totalVolume" column="total_volume"/>
        <result property="totalAmount" column="total_amount"/>
    </resultMap>

    <!-- 查询指标历史分时数据 -->
    <select id="selectIndexByWindCodeListAndDate" resultMap="HistoryTrendIndexDataMap">
        SELECT
            wind_code,
            trade_date,
            latest_price,
            total_volume,
            total_amount
        FROM tb_quotation_index_history_trend
        WHERE trade_date <![CDATA[>=]]> #{startDate}
          AND trade_date <![CDATA[<=]]> #{endDate}
        <if test="indexCodeList != null and indexCodeList.size() > 0">
            AND wind_code IN
            <foreach collection="indexCodeList" item="code" open="(" separator="," close=")">
                #{code}
            </foreach>
        </if>
        ORDER BY trade_date ASC
    </select>

    <!-- 查询指数历史分时数据（回放专用，返回 HistoryTrendDTO） -->
    <!-- 与股票行情统一格式，便于 ReplayScheduler 统一处理 -->
    <select id="selectIndexByTimeRange" resultMap="HistoryTrendDataMap">
        SELECT
            wind_code,
            trade_date,
            latest_price,
            total_volume,
            total_amount as average_price
        FROM tb_quotation_index_history_trend
        WHERE trade_date <![CDATA[>=]]> #{startTime}
          AND trade_date <![CDATA[<=]]> #{endTime}
        <if test="indexCodeList != null and indexCodeList.size() > 0">
            AND wind_code IN
            <foreach collection="indexCodeList" item="code" open="(" separator="," close=")">
                #{code}
            </foreach>
        </if>
        ORDER BY trade_date ASC
    </select>

    <!-- 查询指定交易日各指数的收盘价（即当日最后一条分时数据） -->
    <!-- 用于昨收价缓存预热，返回交易日当天每个指数的收盘价 -->
    <select id="selectIndexPreClosePrice" resultMap="HistoryTrendDataMap">
        WITH RankedData AS (
            SELECT
                wind_code,
                trade_date,
                latest_price,
                ROW_NUMBER() OVER (PARTITION BY wind_code ORDER BY trade_date DESC) as rn
            FROM tb_quotation_index_history_trend
            WHERE DATE(trade_date) = STR_TO_DATE(#{tradeDate}, '%Y%m%d')
              AND status = 1
            <if test="indexCodeList != null and indexCodeList.size() > 0">
                AND wind_code IN
                <foreach collection="indexCodeList" item="code" open="(" separator="," close=")">
                    #{code}
                </foreach>
            </if>
        )
        SELECT
            wind_code,
            trade_date,
            latest_price
        FROM RankedData
        WHERE rn = 1
    </select>

    <!-- 每日 OHLC 数据 ResultMap -->
    <resultMap id="DailyOhlcDataMap" type="com.hao.datacollector.dto.quotation.DailyOhlcDTO">
        <result property="windCode" column="wind_code"/>
        <result property="tradeDate" column="trade_date"/>
        <result property="highPrice" column="high_price"/>
        <result property="lowPrice" column="low_price"/>
        <result property="closePrice" column="close_price"/>
    </resultMap>

    <!-- 查询每日最高价、最低价、收盘价 -->
    <!-- 使用窗口函数获取每日最后一条记录的最新价作为收盘价 -->
    <select id="selectDailyOhlcByStockListAndDate" resultMap="DailyOhlcDataMap">
        WITH DailyStats AS (
            SELECT
                wind_code,
                DATE(trade_date) as trade_date,
                MAX(latest_price) as high_price,
                MIN(latest_price) as low_price
            FROM ${tableName}
            WHERE trade_date <![CDATA[>=]]> #{startDate}
              AND trade_date <![CDATA[<=]]> #{endDate}
            <if test="windCodeList != null and windCodeList.size() > 0">
                AND wind_code IN
                <foreach collection="windCodeList" item="code" open="(" separator="," close=")">
                    #{code}
                </foreach>
            </if>
            GROUP BY wind_code, DATE(trade_date)
        ),
        LastPrice AS (
            SELECT
                wind_code,
                DATE(trade_date) as trade_date,
                latest_price as close_price,
                ROW_NUMBER() OVER (PARTITION BY wind_code, DATE(trade_date) ORDER BY trade_date DESC) as rn
            FROM ${tableName}
            WHERE trade_date <![CDATA[>=]]> #{startDate}
              AND trade_date <![CDATA[<=]]> #{endDate}
            <if test="windCodeList != null and windCodeList.size() > 0">
                AND wind_code IN
                <foreach collection="windCodeList" item="code" open="(" separator="," close=")">
                    #{code}
                </foreach>
            </if>
        )
        SELECT
            ds.wind_code,
            ds.trade_date,
            ds.high_price,
            ds.low_price,
            lp.close_price
        FROM DailyStats ds
        LEFT JOIN LastPrice lp ON ds.wind_code = lp.wind_code
            AND ds.trade_date = lp.trade_date
            AND lp.rn = 1
        ORDER BY ds.trade_date ASC, ds.wind_code ASC
    </select>
</mapper>
